# 기본 날씨 앱

## 주요 구현 사항 & 고민했던 점들

### 1. 뷰컨트롤러에 필요한 데이터 관리 모델
#### 문제상황
- 오픈웨더 맵에서 받아오는 날씨 정보는 hierarchy가 비교적 크고 복잡해서, 데이터를 사용하려면 데이터를 정렬이나 필터링하고, 필요한 데이터 모델로 매핑해서 사용해야했다.
- 또한 앱의 첫번째 화면 FavoriteViewController에서는 도시 정보를 사용자 위치추적을 해서 받아오기도 하고 사용자가 직접 검색해서 받아오기도 하는데, 두 데이터 간의 동작을 달리해야하는 부분을 뷰컨트롤러에서 모두 하면 뷰컨트롤러에서 내부 데이터에 계속 접근하고 값을 바꿔서 사용해야해서 계층 구조가 엉키는 문제가 있었다.

#### 해결
- 데이터의 흐름을 간결화
- 뷰컨트롤러에 필요한 데이터를 관리하는 객체를 따로 생성하여, 뷰컨트롤러가 데이터에 바로 접근해서 화면을 구성하는 로직을 최대한 배제한다.
- 1. `FavoriteViewController`: `FavoriteListManager`
  - FavoriteViewController 는 바로 싱글톤 FavoriteList에 접근하여 값을 꺼내오지 않고, 필요한 값을 FavoriteListManager에 요청한다.
  - 사용자 위치를 알아와서 저장해야하는 FavoriteViewController는 LocationTracker를 가지고 있고, 도시 정보를 받아 직접 리스트에 업데이트하는 것이 아니라 FavoriteListManager에 전달하여 데이터 정렬과 조작을 맡긴다.

- 2. `DetailWeatherViewController`: `DetailWeatherInfo`
  - DetailWeatherViewController는 오늘날씨, 주간날씨, 일간날씨까지 모두 보여줘야해서 뷰컨트롤러가 데이터를 직접 관리하기 매우 복잡했다. 심지어 API가 주간날씨나 일간날씨를 내가 원하는 형태로 지원하지 않아서 따로 데이터를 가공하는 로직이 복잡했다.
  - DetailWeatherViewController는 마찬가지로 DetailWeatherInfo에 데이터를 전달하여 원하는 형태로 가공된 데이터를 돌려받아 테이블뷰와 콜렉션뷰를 구현할 수 있도록 수정했으며, DetailWeatherInfo 내부에서는 해당 객체가 초기화 될때 서버에서부터 받은 데이터를 그냥 사용하는 것이 아니라 미리 필요한 형태로 가공하여 가공된 데이터에만 접근해서 뷰컨트롤러의 요청을 수행한다.


### 2. 유저 데이터 저장
- 사용자가 검색해서 저장한 도시 타입을 `[Int]`로 할 것인지 `[FavoriteCity]`로 할 것인지?
- 타입은 Array가 맞을지 Set이 맞을지?
  - 만약 Int로 한다면 오픈웨더맵 API에서 내려주는 cityID를 저장해서 사용하려고 했는데, 이 방법은 API에 의존하게되므로 FavoriteCity자체를 저장하되 Hashable을 구현해서 사용
  - Set이 unordered라서 [FavoriteCity]로 수정하였고, `remove`와 `add`, `update`만 재 구현함

### 3. 중복코드 제거
- 날씨앱과 같은 정보성 앱은 앱의 각 scene마다 비슷한 동작과 화면으로 구성되어있어서, 중복 코드가 많이 생기게 됨. 이를 프로토콜을 구현하여 주로 해결하려 함. 가장 대표적인 예시가 `IconDownloader` 프로토콜이다.
  - **IconDownloader 프로토콜 구현**: 아이콘을 다운로드하고 캐싱하는 동작이 매 화면마다 겹쳐서 처음엔 super viewController를 만들어 메소드를 구현하고 나머지 sub viewController들은 상속받아서 처리하는 방식을 택했는데, 해당 메소드를 실행하기위해 전역 변수가 필요한 것도 아니고 메소드 하나로 동작이 끝났기에 상속관계를 만드는 것 대신 프로토콜을 만들고 프로토콜 익스텐션으로 메소드를 기본 구현하여 확장성을 더 높였다.

### 4. 이미지 캐싱
- 날씨앱 특성 상 날씨를 표시하는 아이콘 이미지를 한 화면에서 많이 사용하게 되는데, 서버의 응답을 받을때마다 모든 아이콘을 다운받아서 처리하는 낭비를 줄이고자 캐싱을 사용하였다.

#### 문제 상황
1. 한번에 이미지를 캐싱하려니 최초 실행 시 아이콘 로딩 시간이 오래 걸리고 전체적인 UI 동작이 끊김.
2. FileManager에서 임시폴더에서 캐싱폴더로 파일을 옮길때 실패 케이스 다수 발견

#### 해결 & 남은 고민
- 2번 문제는 비동기로 다운로드가 실행되다보니 해당 비동기 블럭에서 파일을 옮기려고 해서, 다른 폴더에 접근해야 하는 파일이 타이밍 문제 상 같은 폴더로 파일을 옮기려고 하는 이슈인 줄 알았다.
- 이에 처음엔 `serialQueue`를 만들어 파일을 옮기는 동작을 sync하게 처리하려고 하였으나, 해결에 실패했다. 더 서치를 해본 결과 FileManager는 sync하게 동작하며, 에러상황은 옮기려는 폴더에 파일이 있는지 먼저 검사 후, 파일이 있다면 해당 폴더를 비워주고 파일을 옮겨야 고칠 수 있음을 알게되었다.
- 따라서, `FileManager.default.fileExists(atPath: destinationPath.path)`라인을 추가하여 로직을 보정했다.

### 5. 주요 Key 숨김처리
- API key처럼 사용하는 정보들을 숨길 필요가 있다고 판단하여, `KeyInfo.plist`파일을 만들어 `KeyInfoLoader`를 만들어 정보를 불러오는 Helper역할 객체를 생성하였다.
- 실제 서비스였다면 `KeyInfo.plist`파일은 .gitignore처리나 또다른 방식으로 숨길 수 있었겠지만 과제 파일이라 별도의 숨김 처리는 하지 않았다.
- 그리고 `KeyInfo.plist`을 SlackWebHook이나 쿼리 스트링, 앱 내부에서 필요한 문자열들을 숨기는 용도로 만들고, API에 필요한 키워드, 앱 내부에서 필요로 하는 `String` 상수 등을 저장하고 가져다 쓰는 목적으로 더 확장해서 쓸 수 있었을텐데, 그렇게까지 구현하지 못해서 아쉽다.


### 아쉬운 점
1. 에러 핸들링 고도화: 사실 이미지 다운로드를 비롯하여 다른 네트워크 동작의 에러핸들링 로직을 좀 더 고도화 할 수 있었는데, 아쉽게도 하지 못했다. 에러핸들링이나 네트워크의 변동사항에 좀더 유연하고 간편하게 대처할 수 있도록 연습을 많이 해야겠다.
2. 유닛테스트 : 유틸성 함수가 테스트 할 거리들이 많았는데 하지 못했다. 테스트함수도 빠르게 짤 수 있도록 연습을 많이 해야겠다!
